<?phpif (!defined('BASEPATH'))	exit('No direct script access allowed');/*	 *	@author : Joyonto Roy *	date	: 1 August, 2013 *	University Of Dhaka, Bangladesh *	Hospital Management system *	http://codecanyon.net/user/joyontaroy */class Pharmacist extends CI_Controller{			function __construct()	{		parent::__construct();        if ($this->session->userdata('pharmacist_login') != 1) {            redirect(base_url() . 'index.php?login', 'refresh');        }        		$this->load->database();        $this->load->model('pharmacist_model');		/*cache control*/		$this->output->set_header('Last-Modified: ' . gmdate("D, d M Y H:i:s") . ' GMT');		$this->output->set_header('Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0');		$this->output->set_header('Pragma: no-cache');		$this->output->set_header("Expires: Mon, 26 Jul 1997 05:00:00 GMT");	}		/***Default function, redirects to login page if no admin logged in yet***/	public function index()	{		if ($this->session->userdata('pharmacist_login') != 1)			redirect(base_url() . 'index.php?login', 'refresh');		if ($this->session->userdata('pharmacist_login') == 1)			redirect(base_url() . 'index.php?pharmacist/dashboard', 'refresh');	}		/***pharmacist DASHBOARD***/	function dashboard()	{		if ($this->session->userdata('pharmacist_login') != 1)			redirect(base_url() . 'index.php?login', 'refresh');					$page_data['page_name']  = 'dashboard';		$page_data['page_title'] = get_phrase('pharmacist_dashboard');		$this->load->view('index', $page_data);	}		/****MANAGE MEDICINE CATEGORIES*********/	function manage_medicine_category($param1 = '', $param2 = '', $param3 = '')	{		if ($this->session->userdata('pharmacist_login') != 1)			redirect(base_url() . 'index.php?login', 'refresh');				if ($param1 == 'create') {			$data['name']        = $this->input->post('name');			$data['description'] = $this->input->post('description');						$this->db->insert('medicine_category', $data);			$this->session->set_flashdata('flash_message', get_phrase('medicine_category_created'));			redirect(base_url() . 'index.php?pharmacist/manage_medicine_category', 'refresh');		}		if ($param1 == 'edit' && $param2 == 'do_update') {			$data['name']        = $this->input->post('name');			$data['description'] = $this->input->post('description');						$this->db->where('medicine_category_id', $param3);			$this->db->update('medicine_category', $data);			$this->session->set_flashdata('flash_message', get_phrase('medicine_category_updated'));			redirect(base_url() . 'index.php?pharmacist/manage_medicine_category', 'refresh');					} else if ($param1 == 'edit') {			$page_data['edit_profile'] = $this->db->get_where('medicine_category', array(				'medicine_category_id' => $param2			))->result_array();		}		if ($param1 == 'delete') {			$this->db->where('medicine_category_id', $param2);			$this->db->delete('medicine_category');			$this->session->set_flashdata('flash_message', get_phrase('medicine_category_deleted'));			redirect(base_url() . 'index.php?pharmacist/manage_medicine_category', 'refresh');		}		$page_data['page_name']           = 'manage_medicine_category';		$page_data['page_title']          = get_phrase('manage_medicine_category');		$page_data['medicine_categories'] = $this->db->get('medicine_category')->result_array();		$this->load->view('index', $page_data);	}		/****MANAGE MEDICINES CATEGORY WISE*********/	function manage_medicine($param1 = '', $param2 = '', $param3 = '')	{	//        print_r($_POST);die;		if ($param1 == 'create') {			$data['medicine_category_id']   = $this->input->post('medicine_category_id');			$data['description']            = $this->input->post('description');			$data['price']                  = $this->input->post('price');			$data['manufacturing_company']  = $this->input->post('manufacturing_company');            $data['retailer_name']          = $this->input->post('retailer_name');            $data['quantity']               = $this->input->post('quantity');            $data['mrp']                    = $this->input->post('mrp');            $data['medicine_purchase_date'] = $this->input->post('purchase_date');            $data['medicine_purchase_date'] = snh_date_format($data['medicine_purchase_date']);            $data['medicine_purchase_date'] = Util::snh_date_format($data['medicine_purchase_date']);            $data['medicine_expiry_date']   = $this->input->post('expiry_date');            $data['medicine_expiry_date']   = Util::snh_date_format($data['medicine_expiry_date']);            $data['batch']                  = $this->input->post('batch');            $data['discount']               = $this->input->post('discount');            $data['vat']                    = $this->input->post('vat');            $data['free_item']              = $this->input->post('free_item');                        if (isset($_POST['is_loose_item'])) {                $data['is_loose_item']       = 1;                $data['loose_item_quantity'] = $this->input->post('loose_item_quantity');            } else {                $data['is_loose_item']       = 0;                $data['loose_item_quantity'] = 0;            }            $this->pharmacist_model->mark_obsolete_to_old_med_stock($data['medicine_category_id']);			$this->db->insert('medicine', $data);			$this->session->set_flashdata('flash_message', get_phrase('medicine_created'));			redirect(base_url() . 'index.php?pharmacist/manage_medicine', 'refresh');		}		if ($param1 == 'edit' && $param2 == 'do_update') {//			$data['name']                   = $this->input->post('name');			$data['medicine_category_id']   = $this->input->post('medicine_category_id');			$data['description']            = $this->input->post('description');			$data['price']                  = $this->input->post('price');			$data['manufacturing_company']  = $this->input->post('manufacturing_company');            $data['retailer_name']          = $this->input->post('retailer_name');            $data['quantity']               = $this->input->post('quantity');            $data['mrp']                    = $this->input->post('mrp');            $data['medicine_purchase_date'] = $this->input->post('purchase_date');            $data['medicine_purchase_date'] = Util::snh_date_format($data['medicine_purchase_date']);            $data['medicine_expiry_date']   = $this->input->post('expiry_date');            $data['medicine_expiry_date']   = Util::snh_date_format($data['medicine_expiry_date']);            $data['batch']                  = $this->input->post('batch');            $data['discount']               = $this->input->post('discount');            $data['vat']                    = $this->input->post('vat');            $data['free_item']              = $this->input->post('free_item');                        if (isset($_POST['is_loose_item'])) {                $data['is_loose_item']       = 1;                $data['loose_item_quantity'] = $this->input->post('loose_item_quantity');            } else {                $data['is_loose_item']       = 0;                $data['loose_item_quantity'] = 0;            }            			$this->db->where('medicine_id', $param3);			$this->db->update('medicine', $data);			$this->session->set_flashdata('flash_message', get_phrase('medicine_updated'));			redirect(base_url() . 'index.php?pharmacist/manage_medicine', 'refresh');		} else if ($param1 == 'edit') {			$page_data['edit_profile'] = $this->db->get_where('medicine', array(				'medicine_id' => $param2			))->result_array();		}		if ($param1 == 'delete') {			$this->db->where('medicine_id', $param2);			$this->db->delete('medicine');			$this->session->set_flashdata('flash_message', get_phrase('medicine_deleted'));			redirect(base_url() . 'index.php?pharmacist/manage_medicine', 'refresh');		}		$page_data['page_name']  = 'manage_medicine';		$page_data['page_title'] = get_phrase('manage_medicine');		$page_data['medicines']  = $this->db->get('medicine')->result_array();		$this->load->view('index', $page_data);	}		/***MANAGE PRESCRIPTIONS******/	function manage_prescription($param1 = '', $param2 = '', $param3 = '')	{		$this->load->helper('util');        		if ($param1 == 'create') {	            			$this->session->set_flashdata('flash_message', get_phrase('prescription_created'));			redirect(base_url() . 'index.php?pharmacist/manage_prescription', 'refresh');		}		if ($param1 == 'edit' && $param2 == 'do_update') {			$data['medication_from_pharmacist'] = $this->input->post('medication_from_pharmacist');			$this->db->where('prescription_id', $param3);			$this->db->update('prescription', $data);			$this->session->set_flashdata('flash_message', get_phrase('prescription_updated'));			redirect(base_url() . 'index.php?pharmacist/manage_prescription', 'refresh');					} else if ($param1 == 'edit') {			$page_data['edit_profile'] = $this->db->get_where('medicine_sale', array(				'id' => $param2			))->result_array();		}		if ($param1 == 'delete' && !empty($param2)) {			$this->db->where('id', $param2);			$this->db->delete('medicine_sale');            log_message('error', $this->db->last_query());			$this->session->set_flashdata('flash_message', get_phrase('prescription_deleted'));			redirect(base_url() . 'index.php?pharmacist/manage_prescription', 'refresh');		}		$page_data['page_name']     = 'manage_prescription';		$page_data['page_title']    = get_phrase('manage_prescription');		$page_data['prescriptions'] = $this->pharmacist_model->get_sold_medicine_details();		$this->load->view('index', $page_data);	}		/******MANAGE OWN PROFILE AND CHANGE PASSWORD***/	function manage_profile($param1 = '', $param2 = '', $param3 = '')	{		if ($this->session->userdata('pharmacist_login') != 1)			redirect(base_url() . 'index.php?login', 'refresh');		if ($param1 == 'update_profile_info') {			$data['name']    = $this->input->post('name');			$data['email']   = $this->input->post('email');			$data['address'] = $this->input->post('address');			$data['phone']   = $this->input->post('phone');						$this->db->where('pharmacist_id', $this->session->userdata('pharmacist_id'));			$this->db->update('pharmacist', $data);			$this->session->set_flashdata('flash_message', get_phrase('profile_updated'));			redirect(base_url() . 'index.php?pharmacist/manage_profile/', 'refresh');		}		if ($param1 == 'change_password') {			$data['password']             = $this->input->post('password');			$data['new_password']         = $this->input->post('new_password');			$data['confirm_new_password'] = $this->input->post('confirm_new_password');						$current_password = $this->db->get_where('pharmacist', array(				'pharmacist_id' => $this->session->userdata('pharmacist_id')			))->row()->password;			if ($current_password == $data['password'] && $data['new_password'] == $data['confirm_new_password']) {				$this->db->where('pharmacist_id', $this->session->userdata('pharmacist_id'));				$this->db->update('pharmacist', array(					'password' => $data['new_password']				));				$this->session->set_flashdata('flash_message', get_phrase('password_updated'));			} else {				$this->session->set_flashdata('flash_message', get_phrase('password_mismatch'));			}			redirect(base_url() . 'index.php?pharmacist/manage_profile/', 'refresh');		}		$page_data['page_name']    = 'manage_profile';		$page_data['page_title']   = get_phrase('manage_profile');		$page_data['edit_profile'] = $this->db->get_where('pharmacist', array(			'pharmacist_id' => $this->session->userdata('pharmacist_id')		))->result_array();		$this->load->view('index', $page_data);	}    public function sold_to_patient()    {            $data = $this->input->post();            $insert_data = array();			$insert_data['patient_name']   = $this->input->post('patient_name');			$insert_data['total_amount']   = $this->input->post('total_amount');            $insert_data['discount']       = $this->input->post('discount');                        $last_insert_id = $this->pharmacist_model->med_sold_to_patient($insert_data);            $total_medicine_count = $data['total_med_details'];            $insert_med_details = array();            if ($total_medicine_count > 0) {                $counter = 1;                for ($i=1; $i<=15; $i++) {                    if (!empty($data['medicine_id' . $i])) {                        $insert_med_details[$counter]['medicine_sale_id'] = $last_insert_id;                        $insert_med_details[$counter]['medicine_id'] = $data['medicine_id' . $i];                        $insert_med_details[$counter]['is_loose_sale'] = !empty($data['selling_loose_quantity' . $i]) ? 1 : 0;                        $insert_med_details[$counter]['quantity'] = $data['quantity' . $i];                        $insert_med_details[$counter]['amount'] = $data['amount' . $i];                        $counter++;                    }                }                if(is_array($insert_med_details) && count($insert_med_details) > 0) {                    $this->pharmacist_model->med_details_sold_to_patient($insert_med_details);                }            }            $this->session->set_flashdata('flash_message', get_phrase('Saved_successfully'));			redirect(base_url() . 'index.php?pharmacist/manage_prescription', 'refresh');            $this->load->view('index', $page_data);    }    }